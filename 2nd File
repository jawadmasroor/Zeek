# /usr/local/zeek/share/zeek/site/dns_monitor.zeek

# Load the base framework for notices
@load base/frameworks/notice
@load base/utils/whitelists

# Define the file path for monitored IPs
const monitored_ips_file = "/usr/local/zeek/share/zeek/site/monitored_ips.txt";

# Global set of monitored IPs
global monitored_ips: set[addr] = set();

# Event to handle DNS responses
event dns_response(c: connection, msg: dns_msg, query: string, answer: dns_answer, orig_rtt: interval)
{
    for (i in answer)
    {
        if ( answer[i]?$A && answer[i]$A in monitored_ips )
        {
            local note = Notice::Log;
            local msg = fmt("Monitored IP %s found in DNS answer field", answer[i]$A);
            NOTICE([$note=note, $msg=msg, $sub=fmt("DNS query for %s", query), $conn=c]);
        }
    }
}

# Input framework to read monitored IPs from file
redef enum Input::READER += { Input::READER_WHITELIST };
Input::add_table([
    $source=monitored_ips_file,
    $reader=Input::READER_WHITELIST,
    $name="monitored_ips",
    $destination=monitored_ips
]);
