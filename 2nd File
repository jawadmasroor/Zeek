# /opt/zeek/share/zeek/site/dns_monitor.zeek

# Load the base framework for notices and Input framework
@load base/frameworks/notice
@load base/frameworks/input

# Define the file path for monitored IPs
const monitored_ips_file = "/opt/zeek/share/zeek/site/monitored_ips.txt";

# Global set of monitored IPs
global monitored_ips: set[addr] = set();

# Input handler to read IPs from file
event zeek_init() {
    Input::add_table([$source=monitored_ips_file, $name="monitored_ips", $mode=Input::STREAM, $fields=Input::READER_RAW, $destination=monitored_ips, $include=set("record")]);
}

# Event to handle DNS responses
event dns_response(c: connection, msg: dns_msg, query: string, answer: dns_answer, orig_rtt: interval)
{
    for (i in answer)
    {
        if ( answer[i]?$A && answer[i]$A in monitored_ips )
        {
            local note = Notice::LOG;
            local msg = fmt("Monitored IP %s found in DNS answer field", answer[i]$A);
            NOTICE([$note=note, $msg=msg, $sub=fmt("DNS query for %s", query), $conn=c]);
        }
    }
}


error in /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 15: orphaned field "fields" in record coercion ((coerce [$source=monitored_ips_file, $name=monitored_ips, $mode=Input::STREAM, $fields=Input::READER_RAW, $destination=monitored_ips, $include=set(record)] to Input::TableDescription))
error in /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 21: target to iterate over must be a table, set, vector, or string (answer)
error in /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 21: undeclared variable (i)
error in /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 23: expression with type 'record' is not a type that can be indexed (answer[i])
error in /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 23: expression with type 'record' is not a type that can be indexed (answer[i])
error in /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 26: expression with type 'record' is not a type that can be indexed (answer[i])
error in /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 19 and /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 26: already defined (msg)
error in /opt/zeek/share/zeek/base/frameworks/notice/./main.zeek, lines 67-183 and /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 27: incompatible record types (Notice::Info and [$note=note, $msg=msg, $sub=fmt(DNS query for %s, query), $conn=c])
error in /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 27 and /opt/zeek/share/zeek/base/frameworks/notice/./main.zeek, lines 67-183: type mismatch ([$note=note, $msg=msg, $sub=fmt(DNS query for %s, query), $conn=c] and Notice::Info)
error in /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 27: argument type mismatch in function call (NOTICE([$note=note, $msg=msg, $sub=fmt(DNS query for %s, query), $conn=c]))
