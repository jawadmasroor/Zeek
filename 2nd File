# /opt/zeek/share/zeek/site/dns_monitor.zeek

# Load the base framework for notices and Input framework
@load base/frameworks/notice
@load base/frameworks/input

# Define the file path for monitored IPs
const monitored_ips_file = "/opt/zeek/share/zeek/site/monitored_ips.txt";

# Global set of monitored IPs
global monitored_ips: set[addr] = set();

# Input handler to read IPs from file
event zeek_init() {
    Input::add_table([$source=monitored_ips_file, $name="monitored_ips", $fields=Input::READER_RAW, $destination=monitored_ips]);
}

# Event to handle DNS responses
event dns_response(c: connection, msg: dns_msg, query: string, answer: dns_answer, orig_rtt: interval) {
    for (a in answer) {
        if (a?$A && a$A in monitored_ips) {
            local notice_msg = fmt("Monitored IP %s found in DNS answer field", a$A);
            NOTICE([$note=Notice::LOG, $msg=notice_msg, $sub=fmt("DNS query for %s", query), $conn=c]);
        }
    }
}


error in /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 15: orphaned field "fields" in record coercion ((coerce [$source=monitored_ips_file, $name=monitored_ips, $fields=Input::READER_RAW, $destination=monitored_ips] to Input::TableDescription))
error in /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 20: target to iterate over must be a table, set, vector, or string (answer)
error in /opt/zeek/share/zeek/site/./dns_monitor.zeek, line 20: undeclared variable (a)
